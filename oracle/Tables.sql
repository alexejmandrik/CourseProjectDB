-- 1 Таблица ролей
CREATE TABLE ROLES (
    ROLE_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ROLE_NAME VARCHAR2(50) NOT NULL UNIQUE
);

-- 2 Таблица  пользователей
CREATE TABLE USERS (
    USER_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    LOGIN VARCHAR2(50) NOT NULL UNIQUE,
    PASSWORD_HASH VARCHAR2(256) NOT NULL,
    FULL_NAME VARCHAR2(100) NOT NULL, 
    PHONE VARCHAR2(20) NOT NULL,
    STATUS VARCHAR2(20) DEFAULT 'ACTIVE' CHECK (STATUS IN ('ACTIVE', 'BLOCKED')),
    ROLE_ID NUMBER NOT NULL,
    CONSTRAINT FK_USERS_ROLE FOREIGN KEY (ROLE_ID)
        REFERENCES ROLES (ROLE_ID)
        ON DELETE CASCADE
);

-- 3 Таблица транспортных средств
CREATE TABLE VEHICLES (
    VEHICLE_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    REG_NUMBER VARCHAR2(20) NOT NULL,
    MODEL VARCHAR2(100) NOT NULL,
    CAPACITY NUMBER(5) NOT NULL,
    STATUS VARCHAR2(20) DEFAULT 'OK' CHECK (STATUS IN ('OK', 'IN_SERVICE'))
);

-- 4 Таблица маршрутов
CREATE TABLE ROUTES (
    ROUTE_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    START_POINT VARCHAR2(100) NOT NULL,
    END_POINT VARCHAR2(100) NOT NULL,
    DISTANCE_KM NUMBER(10,2) NOT NULL
);

-- 5 Таблица поездок
CREATE TABLE TRAVELS (
    TRAVEL_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ROUTE_ID NUMBER NOT NULL,
    VEHICLE_ID NUMBER,
    DRIVER_ID NUMBER NOT NULL,
    DEPARTURE_DATE DATE NOT NULL,
    ARRIVAL_DATE DATE NOT NULL,
    STATUS VARCHAR2(20) DEFAULT 'OK' CHECK (STATUS IN ('OK', 'CANCELED')),
    PRICE NUMBER(10,2) DEFAULT 0,
    CONSTRAINT FK_TRAVELS_ROUTE FOREIGN KEY (ROUTE_ID)
        REFERENCES ROUTES (ROUTE_ID)
        ON DELETE CASCADE,
    CONSTRAINT FK_TRAVELS_VEHICLE FOREIGN KEY (VEHICLE_ID)
        REFERENCES VEHICLES (VEHICLE_ID)
        ON DELETE SET NULL,
    CONSTRAINT FK_TRAVELS_DRIVER FOREIGN KEY (DRIVER_ID)
        REFERENCES USERS (USER_ID)
        ON DELETE SET NULL
);

-- 6 Таблица статистики
CREATE TABLE STATISTICS (
    STAT_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TRAVEL_ID NUMBER NOT NULL,
    REVENUE NUMBER(12,2) NOT NULL,
    FUEL_USED NUMBER(8,2) NOT NULL,
    PASSENGERS_COUNT NUMBER(5) NOT NULL,
    CONSTRAINT FK_STATS_TRAVEL FOREIGN KEY (TRAVEL_ID)
        REFERENCES TRAVELS (TRAVEL_ID)
        ON DELETE CASCADE
)
INMEMORY;



-- 7 Таблица бронирований
CREATE TABLE BOOKINGS (
    BOOKING_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TRAVEL_ID NUMBER,
    USER_ID NUMBER NOT NULL,
    BOOKING_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    STATUS VARCHAR2(20)  DEFAULT 'BOOKED' CHECK (STATUS IN ('BOOKED', 'SHOW', 'NO_SHOW', 'COMPLETED')),
    PRICE NUMBER(10,2) DEFAULT 0,
    CONSTRAINT FK_BOOKING_TRAVEL FOREIGN KEY (TRAVEL_ID) REFERENCES TRAVELS(TRAVEL_ID) ON DELETE SET NULL,
    CONSTRAINT FK_BOOKING_USER FOREIGN KEY (USER_ID) REFERENCES USERS(USER_ID)
)
INMEMORY;

ALTER TABLE bookings  INMEMORY priority high;
ALTER TABLE travels  INMEMORY priority high;
ALTER TABLE STATISTICS  INMEMORY priority high;

ALTER TABLE STATISTICS no INMEMORY;
ALTER TABLE bookings no INMEMORY;
ALTER TABLE travels no INMEMORY;


drop table STATISTICS;
DROP TABLE BOOKINGS;
drop table TRAVELS;
drop table ROUTES;
drop table VEHICLES;
drop table USERS;
drop table ROLES;

ALTER TABLE USERS MODIFY USER_ID GENERATED BY DEFAULT AS IDENTITY (START WITH 1);
ALTER TABLE ROLES MODIFY ROLE_ID GENERATED BY DEFAULT AS IDENTITY (START WITH 1);
ALTER TABLE VEHICLES MODIFY VEHICLE_ID GENERATED BY DEFAULT AS IDENTITY (START WITH 1);
ALTER TABLE ROUTES MODIFY ROUTE_ID GENERATED BY DEFAULT AS IDENTITY (START WITH 1);
ALTER TABLE TRAVELS MODIFY TRAVEL_ID GENERATED BY DEFAULT AS IDENTITY (START WITH 1);
ALTER TABLE STATISTICS MODIFY STAT_ID GENERATED BY DEFAULT AS IDENTITY (START WITH 1);
ALTER TABLE BOOKINGS MODIFY BOOKING_ID GENERATED BY DEFAULT AS IDENTITY (START WITH 1);
